<!DOCTYPE html>
<html lang="ru" data-theme="{{ theme }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Временное хранилище</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root[data-theme="light"] {
            --bg-color: #ffffff;
            --text-color: #000000;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --hover-bg: #f8f9fa;
            --shadow-color: rgba(0,0,0,0.1);
        }
        
        :root[data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --card-bg: #2d2d2d;
            --border-color: #404040;
            --hover-bg: #3d3d3d;
            --shadow-color: rgba(0,0,0,0.3);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .card {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }
        
        .file-table {
            color: var(--text-color);
        }
        
        .file-table thead {
            position: sticky;
            top: 0;
            z-index: 1;
            box-shadow: 0 2px 4px var(--shadow-color);
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .file-table th,
        .file-table td {
            border-color: var(--border-color);
        }
        
        .file-table tr:hover {
            background-color: var(--hover-bg);
        }
        
        .theme-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        .theme-switch:hover {
            transform: scale(1.1);
        }
        
        .theme-switch i {
            font-size: 20px;
            color: var(--text-color);
        }
        
        .storage-info {
            margin-bottom: 10px;
        }
        .storage-progress {
            margin-bottom: 10px;
        }
        .storage-progress .progress {
            height: 25px;
            background-color: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            position: relative;
        }
        .storage-progress .progress-bar {
            font-size: 14px;
            line-height: 25px;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            color: white;
            font-weight: bold;
            background: linear-gradient(to right, 
                #28a745 0%, 
                #28a745 15%, 
                #4ca743 20%,
                #70a742 25%,
                #94a740 30%,
                #b8a73f 35%,
                #dca73d 40%,
                #ffc107 45%,
                #ff9f07 50%,
                #ff7d07 55%,
                #ff5b07 60%,
                #ff3907 65%,
                #dc3545 70%,
                #dc3545 100%
            );
            background-size: var(--bg-size, 100%) 100%;
            background-position: 0 0;
        }
        .storage-progress .progress-bar[aria-valuenow="0"],
        .storage-progress .progress-bar[aria-valuenow="0.0"] {
            min-width: 0;
            padding: 0;
        }
        .storage-progress .progress-bar[aria-valuenow^="0"],
        .storage-progress .progress-bar[aria-valuenow^="1"],
        .storage-progress .progress-bar[aria-valuenow^="2"],
        .storage-progress .progress-bar[aria-valuenow^="3"] {
            background-color: #28a745;
        }
        .storage-progress .progress-bar[aria-valuenow^="4"],
        .storage-progress .progress-bar[aria-valuenow^="5"],
        .storage-progress .progress-bar[aria-valuenow^="6"] {
            background-color: #ffc107;
        }
        .storage-progress .progress-bar[aria-valuenow^="7"],
        .storage-progress .progress-bar[aria-valuenow^="8"],
        .storage-progress .progress-bar[aria-valuenow^="9"],
        .storage-progress .progress-bar[aria-valuenow^="100"] {
            background-color: #dc3545;
        }
        .storage-text {
            font-size: 16px;
            font-weight: bold;
            padding: 5px;
        }
        .files-list {
            margin-top: 20px;
        }
        
        .select-all-container {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .file-list {
            max-height: 400px;
            overflow-y: auto;
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .file-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .file-table th {
            padding: 12px 10px;
            text-align: left;
            background-color: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 2;
            border-bottom: 2px solid var(--border-color);
        }
        
        .file-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .file-table tr:last-child td {
            border-bottom: none;
        }
        .file-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
            min-width: 100px;
        }
        .delete-selected {
            margin-bottom: 10px;
            padding: 5px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none;
        }
        .delete-selected:hover {
            background-color: #c82333;
        }
        .download-selected {
            margin-bottom: 10px;
            padding: 5px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none;
        }
        .download-selected:hover {
            background-color: #218838;
        }
        .file-checkbox {
            width: 18px;
            height: 18px;
            margin: 0;
        }
        .upload-progress {
            display: none;
            margin-top: 10px;
        }
        .upload-progress .progress {
            height: 20px;
            background-color: #f5f5f5;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .upload-progress .progress-bar {
            background: #4a90e2;
            transition: width 0.2s ease;
            background-image: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.15) 75%,
                transparent 75%,
                transparent
            );
            background-size: 40px 40px;
            animation: progress-bar-stripes 1s linear infinite;
            height: 100%;
        }
        .upload-progress .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        @keyframes progress-bar-stripes {
            from { background-position: 40px 0; }
            to { background-position: 0 0; }
        }
        .btn-download, .btn-delete {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
        }
        .btn-download {
            background-color: #28a745;
            color: white;
        }
        .btn-download:hover {
            background-color: #218838;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background-color: #c82333;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        /* Стили для всплывающих уведомлений */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 12px 24px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease-out;
            border: 1px solid var(--border-color);
            max-width: 400px;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.success {
            border-left: 4px solid #2ecc71;
        }

        .toast-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        .toast-message {
            flex-grow: 1;
            font-size: 14px;
        }

        .toast-close {
            cursor: pointer;
            opacity: 0.7;
            margin-left: 12px;
            font-size: 18px;
        }

        .toast-close:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .expires-at {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
            box-shadow: 0 2px 4px var(--shadow-color);
            color: var(--text-color);
        }
        
        .page-title {
            text-align: center;
            padding: 15px 25px;
            margin-bottom: 30px;
            background-color: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 4px 8px var(--shadow-color);
            position: relative;
            overflow: hidden;
        }
        
        .page-title h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-color);
            position: relative;
            z-index: 2;
        }
        
        @keyframes rainbow-animation {
            0% {background-position: 0% 50%;}
            50% {background-position: 100% 50%;}
            100% {background-position: 0% 50%;}
        }
        
        .page-title::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, 
                #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8f00ff, #ff0000);
            background-size: 200% 200%;
            animation: rainbow-animation 5s linear infinite;
            z-index: 1;
        }
        
        .drop-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            background-color: var(--bg-color);
            position: relative;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .drop-area.highlight {
            border-color: #4caf50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .drop-area-content {
            width: 100%;
        }
        
        .drop-area i {
            color: var(--text-color);
            opacity: 0.7;
        }
        
        .drop-area p {
            margin: 10px 0;
            color: var(--text-color);
        }
        
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: -1;
        }
    </style>
</head>
<body>
    <!-- Добавляем контейнер для уведомлений -->
    <div class="toast-container"></div>
    <button class="theme-switch" title="Переключить тему">
        <i class="fas fa-moon"></i>
    </button>
    
    <div class="container mt-4">
        <div class="page-title">
            <h1><i class="fas fa-cloud-upload-alt mr-2"></i> Временное хранилище</h1>
        </div>
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="storage-info">
                    <div class="storage-progress">
                        <div class="progress">
                            <div class="progress-bar" 
                                 style="width: {{ '%.1f' % used_percent }}%"
                                 role="progressbar" 
                                 aria-valuenow="{{ '%.1f' % used_percent }}"
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ '%.1f' % used_percent }}%
                            </div>
                        </div>
                    </div>
                    <div class="storage-text">
                        Использовано: {{ '%.2f' % used_space }} MB из 500 MB
                    </div>
                    {% if remaining_time %}
                    <div class="expires-at">Срок действия до: {{ expires_at }} (осталось: {{ remaining_time }})</div>
                    {% elif expires_at %}
                    <div class="expires-at">Срок действия до: {{ expires_at }}</div>
                    {% endif %}
                </div>
                <div class="mt-3 d-flex justify-content-end">
                    <button id="delete-storage" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Удалить хранилище
                    </button>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Загрузка файлов</h5>
                <div id="dropArea" class="drop-area mb-3">
                    <div class="drop-area-content">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                        <p>Перетащите файлы сюда или нажмите для выбора</p>
                        <p class="text-muted small">Максимальный размер файла: 500 МБ</p>
                        <p class="text-muted small">Разрешенные типы файлов: {{ ', '.join(allowed_extensions) }}</p>
                        <form id="uploadForm" enctype="multipart/form-data">
                            <input type="file" class="file-input" id="fileInput" multiple>
                            <button type="button" class="btn btn-primary mt-3" id="selectFilesBtn">Выбрать файлы</button>
                        </form>
                    </div>
                </div>
                <div class="upload-progress">
                    <div class="progress mt-2">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="progress-text"></div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="toggleFilesList">
                            Показать список файлов <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="files-upload-list mt-2" style="display: none;">
                        <!-- Здесь будет отображаться список загружаемых файлов -->
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="files-list">
                    <h2>Файлы в хранилище</h2>
                    <div class="select-all-container">
                        <input type="checkbox" id="select-all" class="file-checkbox">
                        <label for="select-all">Выбрать все</label>
                        <button id="delete-selected" class="delete-selected">Удалить выбранные</button>
                        <button id="download-selected" class="download-selected">
                            <i class="fas fa-download"></i> Скачать выбранные
                        </button>
                    </div>
                    <div class="file-list">
                        <table class="file-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Имя файла</th>
                                    <th>Размер</th>
                                    <th>Дата изменения</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in files %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="file-checkbox" data-filename="{{ file.name }}">
                                    </td>
                                    <td class="text-truncate" style="max-width: 200px;" title="{{ file.name|e }}">{{ file.name|e }}</td>
                                    <td>{{ (file.size / 1024 / 1024)|round(2) }} MB</td>
                                    <td>{{ file.modified.strftime('%d.%m.%Y %H:%M:%S') }}</td>
                                    <td class="file-actions">
                                        <a href="{{ url_for('download_file', link_id=link_id, filename=file.name|urlencode) }}" 
                                           class="btn btn-download" title="Скачать">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <button class="btn btn-delete" 
                                                onclick="deleteFile('{{ file.name|e|escapejs }}')" 
                                                title="Удалить">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const linkId = '{{ link_id }}';
        let totalUploadSize = 0;
        let currentUploadedSize = 0;
        let uploadControllers = new Map(); // Map для хранения AbortController для каждого файла
        
        // Настройка Drag and Drop
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const selectFilesBtn = document.getElementById('selectFilesBtn');
        
        // Предотвращаем стандартное поведение браузера (открытие файла)
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Подсветка области при перетаскивании файлов
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        // Обработка сброшенных файлов
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                handleFiles(files);
            }
        }
        
        // Обработка выбора файлов через кнопку
        selectFilesBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleFiles(fileInput.files);
            }
        });
        
        // Функция обработки файлов
        function handleFiles(files) {
            if (files.length === 0) {
                showToast('Пожалуйста, выберите файлы для загрузки', 'error');
                return;
            }
            
            const uploadProgress = document.querySelector('.upload-progress');
            const progressBar = uploadProgress.querySelector('.progress-bar');
            const filesList = document.querySelector('.files-upload-list');
            uploadProgress.style.display = 'block';
            filesList.innerHTML = ''; // Очищаем список
            
            // Получаем CSRF-токен из метатега
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Рассчитываем общий размер всех файлов
            totalUploadSize = Array.from(files).reduce((total, file) => total + file.size, 0);
            currentUploadedSize = 0;
            
            // Создаем список файлов
            Array.from(files).forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-upload-item';
                fileItem.id = `file-upload-${index}`;
                fileItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div class="file-info">
                            <div class="file-name text-truncate" style="max-width: 300px;">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                        <div class="file-progress" style="width: 60%;">
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="progress-${index}"></div>
                            </div>
                            <div class="progress-text small text-muted mt-1" id="progress-text-${index}">Ожидание...</div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger cancel-upload" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                filesList.appendChild(fileItem);
                
                // Добавляем обработчик для кнопки отмены
                fileItem.querySelector('.cancel-upload').addEventListener('click', function() {
                    const fileIndex = this.getAttribute('data-index');
                    cancelUpload(fileIndex);
                });
            });
            
            // Показываем список файлов
            filesList.style.display = 'block';
            document.getElementById('toggleFilesList').innerHTML = 'Скрыть список файлов <i class="fas fa-chevron-up"></i>';
            
            // Запускаем загрузку файлов
            Array.from(files).forEach((file, index) => {
                uploadFile(file, index);
            });
        }
        
        // Доработанная функция для toggle списка файлов
        document.getElementById('toggleFilesList').addEventListener('click', function() {
            const filesList = document.querySelector('.files-upload-list');
            const isVisible = filesList.style.display !== 'none';
            filesList.style.display = isVisible ? 'none' : 'block';
            this.innerHTML = isVisible ? 
                'Показать список файлов <i class="fas fa-chevron-down"></i>' : 
                'Скрыть список файлов <i class="fas fa-chevron-up"></i>';
        });
        
        async function uploadFile(file, index) {
            try {
                let currentChunkSize = 1024 * 1024; // 1MB chunks
                const totalSize = file.size;
                let uploadedSize = 0;
                
                // Ограничиваем максимальный размер файла
                const MAX_FILE_SIZE = 500 * 1024 * 1024; // 500 MB
                if (totalSize > MAX_FILE_SIZE) {
                    updateFileStatus(index, 'error', `Файл слишком большой. Макс. размер: 500 MB`);
                    return;
                }
                
                // Безопасная проверка лимита хранилища
                const usedSpace = Math.max(0, parseFloat('{{ used_space }}'));
                const remaining = Math.max(0, 500 - usedSpace); // 500 MB - текущее использование
                
                // Гарантируем, что значения корректны
                if (isNaN(remaining) || !isFinite(remaining)) {
                    updateFileStatus(index, 'error', `Ошибка при проверке свободного места`);
                    return;
                }
                
                if (totalSize / (1024 * 1024) > remaining) {
                    updateFileStatus(index, 'error', `Файл превысит лимит хранилища. Осталось: ${remaining.toFixed(2)} MB`);
                    return;
                }

                // Создаем AbortController для этого файла
                const controller = new AbortController();
                uploadControllers.set(index, controller);

                let chunkNumber = 0;
                updateFileStatus(index, 'uploading', 'Начало загрузки...');
                
                // Создаем уникальный идентификатор сессии загрузки
                const uploadSessionId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                while (uploadedSize < totalSize) {
                    if (!uploadControllers.has(index)) {
                        console.log(`Загрузка файла ${file.name} была отменена, выходим из цикла отправки`);
                        
                        // Пытаемся удалить частично загруженный файл
                        try {
                            await fetch(`/space/${linkId}/delete/${file.name}`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRF-Token': csrfToken
                                }
                            });
                        } catch (e) {
                            console.error('Ошибка при удалении частично загруженного файла:', e);
                        }
                        
                        return;
                    }
                    
                    const chunk = file.slice(uploadedSize, Math.min(uploadedSize + currentChunkSize, totalSize));
                    const formData = new FormData();
                    formData.append('file', new Blob([chunk], { type: file.type }), file.name);
                    formData.append('chunk', chunkNumber.toString());
                    formData.append('chunks', Math.ceil(totalSize / currentChunkSize).toString());
                    formData.append('total_size', totalSize.toString());
                    formData.append('upload_session_id', uploadSessionId);

                    let retries = 3;
                    let uploaded = false;

                    while (retries > 0 && !uploaded) {
                        try {
                            // Если загрузка отменена - выходим немедленно
                            if (!uploadControllers.has(index)) {
                                console.log(`Загрузка файла ${file.name} была отменена после запроса`);
                                // Пытаемся удалить частично загруженный файл
                                try {
                                    await fetch(`/space/${linkId}/delete/${file.name}`, {
                                        method: 'POST',
                                        headers: {
                                            'X-CSRF-Token': csrfToken
                                        }
                                    });
                                } catch (deleteErr) {
                                    console.error('Ошибка при удалении частично загруженного файла:', deleteErr);
                                }
                                return;
                            }

                            const response = await fetch(`/space/${linkId}/upload`, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRF-Token': csrfToken
                                },
                                signal: controller.signal
                            });

                            if (!response.ok) {
                                if (response.status === 413) {
                                    currentChunkSize = Math.floor(currentChunkSize / 2);
                                    if (currentChunkSize < 64 * 1024) {
                                        throw new Error('Невозможно уменьшить размер чанка дальше');
                                    }
                                    continue;
                                }

                                const contentType = response.headers.get('content-type');
                                const errorData = contentType && contentType.includes('application/json') 
                                    ? await response.json()
                                    : { error: await response.text() };
                                
                                // Проверяем на ошибку превышения лимита
                                if (response.status === 400 && errorData.error && 
                                    (errorData.error.includes('Превышен лимит') || 
                                     errorData.error.includes('превыш'))) {
                                    updateFileStatus(index, 'error', 'Превышен лимит хранилища');
                                    // Явно удаляем контроллер, чтобы прервать загрузку
                                    uploadControllers.delete(index);
                                    showToast('Превышен лимит хранилища. Загрузка отменена.', 'error');
                                    return; // Выходим из функции, прекращая загрузку
                                }
                                
                                // Обработка ошибки неразрешенного типа файла
                                if (response.status === 400 && errorData.error && 
                                    errorData.error.includes('Тип файла не разрешен')) {
                                    const errorMessage = `Тип файла не разрешен для загрузки (разрешены только: ${document.querySelector('.drop-area .text-muted:nth-of-type(3)').textContent.split(': ')[1]})`;
                                    updateFileStatus(index, 'error', errorMessage);
                                    uploadControllers.delete(index);
                                    showToast(errorMessage, 'error');
                                    return;
                                }
                                
                                throw new Error(errorData.error || 'Неизвестная ошибка');
                            }

                            const result = await response.json();
                            if (!result.success) {
                                throw new Error(result.error || 'Неизвестная ошибка');
                            }

                            uploadedSize += chunk.size;
                            currentUploadedSize += chunk.size;
                            
                            // Обновляем общий прогресс загрузки
                            const totalProgress = (currentUploadedSize / totalUploadSize) * 100;
                            document.querySelector('.upload-progress .progress-bar').style.width = `${totalProgress}%`;
                            document.querySelector('.upload-progress .progress-text').textContent = 
                                `Общий прогресс: ${Math.round(totalProgress)}%`;
                            
                            // Обновляем прогресс для текущего файла
                            const fileProgress = (uploadedSize / totalSize) * 100;
                            updateFileStatus(
                                index, 
                                'uploading', 
                                `${formatFileSize(uploadedSize)} из ${formatFileSize(totalSize)} (${Math.round(fileProgress)}%)`,
                                fileProgress
                            );
                            
                            uploaded = true;
                            chunkNumber++;

                            await new Promise(resolve => setTimeout(resolve, 50));

                        } catch (error) {
                            if (error.name === 'AbortError') {
                                updateFileStatus(index, 'cancelled', 'Загрузка отменена');
                                return;
                            }
                            
                            retries--;
                            if (retries === 0) {
                                updateFileStatus(index, 'error', `Ошибка: ${error.message}`);
                                throw error;
                            }
                            
                            updateFileStatus(index, 'retrying', `Повторная попытка ${3-retries}/3...`);
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }

                    if (!uploaded) {
                        updateFileStatus(index, 'error', 'Не удалось загрузить после всех попыток');
                        throw new Error('Не удалось загрузить часть файла после всех попыток');
                    }
                }

                // Файл успешно загружен
                updateFileStatus(index, 'completed', 'Загрузка завершена');
                uploadControllers.delete(index);

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Ошибка:', error);
                    updateFileStatus(index, 'error', `Ошибка: ${error.message}`);
                }
            }
            
            // Проверяем, остались ли еще загрузки
            checkAllUploadsCompleted();
        }
        
        function updateFileStatus(index, status, message, progress = null) {
            const progressBar = document.getElementById(`progress-${index}`);
            const progressText = document.getElementById(`progress-text-${index}`);
            const fileItem = document.getElementById(`file-upload-${index}`);
            
            if (!fileItem) return;
            
            if (progressBar && progress !== null) {
                progressBar.style.width = `${progress}%`;
            }
            
            if (progressText) {
                progressText.textContent = message;
            }
            
            // Обновляем стили в зависимости от статуса
            if (status === 'uploading') {
                progressBar.classList.remove('bg-danger', 'bg-success', 'bg-warning');
                progressBar.classList.add('bg-primary');
            } else if (status === 'completed') {
                progressBar.classList.remove('bg-danger', 'bg-primary', 'bg-warning');
                progressBar.classList.add('bg-success');
                progressBar.style.width = '100%';
            } else if (status === 'error') {
                progressBar.classList.remove('bg-primary', 'bg-success', 'bg-warning');
                progressBar.classList.add('bg-danger');
            } else if (status === 'cancelled' || status === 'retrying') {
                progressBar.classList.remove('bg-primary', 'bg-success', 'bg-danger');
                progressBar.classList.add('bg-warning');
            }
        }
        
        function cancelUpload(fileIndex) {
            const controller = uploadControllers.get(parseInt(fileIndex));
            if (controller) {
                controller.abort();
                uploadControllers.delete(parseInt(fileIndex));
                updateFileStatus(fileIndex, 'cancelled', 'Загрузка отменена');
                
                // Немедленно скрываем элемент интерфейса загрузки этого файла, чтобы предотвратить повторные запросы
                const fileItem = document.getElementById(`file-upload-${fileIndex}`);
                if (fileItem && fileItem.parentNode) {
                    fileItem.style.opacity = '0.5';
                    const cancelButton = fileItem.querySelector('.cancel-upload');
                    if (cancelButton) {
                        cancelButton.disabled = true;
                        cancelButton.classList.add('disabled');
                    }
                }
                
                // Отправляем запрос на сервер для удаления частично загруженного файла
                const filename = document.querySelector(`#file-upload-${fileIndex} .file-name`).textContent;
                if (filename) {
                    fetch(`/space/${linkId}/delete/${filename}`, {
                        method: 'POST'
                    }).catch(err => console.error('Не удалось удалить частично загруженный файл:', err));
                }
                
                // Проверяем если все загрузки завершены или отменены
                checkAllUploadsCompleted();
            }
        }
        
        function checkAllUploadsCompleted() {
            // Проверяем активные загрузки
            if (uploadControllers.size === 0) {
                const allFiles = document.querySelectorAll('.file-upload-item');
                const hasErrors = Array.from(allFiles).some(file => 
                    file.querySelector('.progress-bar').classList.contains('bg-danger'));
                const hasCancelled = Array.from(allFiles).some(file => 
                    file.querySelector('.progress-bar').classList.contains('bg-warning') &&
                    file.querySelector('.progress-text').textContent.includes('отменена'));
                
                if (hasCancelled) {
                    showToast('Некоторые загрузки были отменены', 'error');
                    document.querySelector('.upload-progress .progress-text').innerHTML = 
                        '<span class="text-warning">Некоторые загрузки были отменены</span>';
                } else if (hasErrors) {
                    // Соберем все ошибки для показа
                    const errorMessages = Array.from(allFiles)
                        .filter(file => file.querySelector('.progress-bar').classList.contains('bg-danger'))
                        .map(file => file.querySelector('.progress-text').textContent)
                        .join('; ');
                    
                    showToast('При загрузке некоторых файлов произошли ошибки', 'error');
                    document.querySelector('.upload-progress .progress-text').innerHTML = 
                        `<span class="text-danger">Ошибки: ${escapeHtml(errorMessages)}</span>`;
                } else {
                    showToast('Все файлы успешно загружены', 'success');
                    document.querySelector('.upload-progress .progress-text').innerHTML = 
                        '<span class="text-success">Все файлы успешно загружены</span>';
                }
                
                // В любом случае перезагружаем страницу через 2 секунды
                setTimeout(() => location.reload(), 2000);
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
            else return (bytes / 1073741824).toFixed(1) + ' GB';
        }

        async function deleteFile(filename) {
            if (!confirm('Вы уверены, что хотите удалить этот файл?')) {
                return;
            }
            
            try {
                const response = await fetch(`/space/${linkId}/delete/${filename}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка при удалении файла');
                }
                
                if (data.success) {
                    showToast('Файл успешно удален', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            } catch (error) {
                handleError(error);
            }
        }

        document.getElementById('select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.file-checkbox:not(#select-all)');
            checkboxes.forEach(checkbox => checkbox.checked = this.checked);
            updateButtonsVisibility();
        });

        document.querySelectorAll('.file-checkbox:not(#select-all)').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateButtonsVisibility();
                // Обновляем состояние "выбрать все"
                const allCheckboxes = document.querySelectorAll('.file-checkbox:not(#select-all)');
                const checkedBoxes = document.querySelectorAll('.file-checkbox:not(#select-all):checked');
                document.getElementById('select-all').checked = allCheckboxes.length === checkedBoxes.length;
            });
        });

        function updateButtonsVisibility() {
            const checkedBoxes = document.querySelectorAll('.file-checkbox:not(#select-all):checked');
            const deleteButton = document.getElementById('delete-selected');
            const downloadButton = document.getElementById('download-selected');
            const hasChecked = checkedBoxes.length > 0;
            
            deleteButton.style.display = hasChecked ? 'inline-block' : 'none';
            downloadButton.style.display = hasChecked ? 'inline-block' : 'none';
        }

        document.getElementById('download-selected').addEventListener('click', async function() {
            const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:not(#select-all):checked'))
                .map(checkbox => checkbox.getAttribute('data-filename'));
            
            if (selectedFiles.length === 0) {
                alert('Выберите файлы для скачивания');
                return;
            }

            try {
                const response = await fetch(`/space/${linkId}/download-multiple`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ files: selectedFiles })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `files_${linkId}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Ошибка при скачивании файлов', 'error');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showToast('Произошла ошибка при скачивании файлов', 'error');
            }
        });

        document.getElementById('delete-selected').addEventListener('click', async function() {
            const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:not(#select-all):checked'))
                .map(checkbox => checkbox.getAttribute('data-filename'));
            
            if (selectedFiles.length === 0) {
                showToast('Выберите файлы для удаления', 'error');
                return;
            }

            if (!confirm('Вы уверены, что хотите удалить выбранные файлы?')) {
                return;
            }

            for (const filename of selectedFiles) {
                try {
                    const response = await fetch(`/space/${linkId}/delete/${filename}`, {
                        method: 'POST',
                        headers: {
                            'X-CSRF-Token': csrfToken
                        }
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        console.error(`Ошибка при удалении файла ${filename}:`, error);
                        showToast(`Ошибка при удалении файла ${filename}: ${error.error || 'неизвестная ошибка'}`, 'error');
                    }
                } catch (error) {
                    console.error(`Ошибка при удалении файла ${filename}:`, error);
                    showToast(`Ошибка при удалении файла ${filename}`, 'error');
                }
            }

            // Перезагружаем страницу после удаления
            location.reload();
        });

        document.getElementById('delete-storage').addEventListener('click', async function() {
            if (!confirm('Вы уверены, что хотите удалить все файлы и освободить пространство хранилища?')) {
                return;
            }

            try {
                const response = await fetch(`/space/${linkId}/delete-all`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Ошибка при удалении всех файлов');
                }
                
                location.reload();
            } catch (error) {
                console.error('Ошибка:', error);
                alert(`Ошибка при удалении всех файлов: ${error.message}`);
            }
        });

        // Функция для переключения темы
        async function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            const themeIcon = document.querySelector('.theme-switch i');
            
            html.setAttribute('data-theme', newTheme);
            themeIcon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            
            try {
                const response = await fetch(`/space/${linkId}/set-theme`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ theme: newTheme })
                });
                
                if (!response.ok) {
                    console.error('Ошибка при сохранении темы');
                }
            } catch (error) {
                console.error('Ошибка при сохранении темы:', error);
            }
        }
        
        // Добавляем обработчик для кнопки переключения темы
        document.querySelector('.theme-switch').addEventListener('click', toggleTheme);
        
        // Устанавливаем правильную иконку при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const themeIcon = document.querySelector('.theme-switch i');
            themeIcon.className = currentTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            
            // Существующий код инициализации
            const progressBar = document.querySelector('.storage-progress .progress-bar');
            const value = parseFloat(progressBar.getAttribute('aria-valuenow'));
            progressBar.style.setProperty('--value', '100%');
            progressBar.style.setProperty('--bg-size', (100 * 100 / value) + '%');
            
            updateButtonsVisibility();
        });

        // Функция для показа уведомлений
        function showToast(message, type = 'error') {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                console.error('Контейнер для уведомлений не найден');
                return;
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'toast-error' : type === 'success' ? 'toast-success' : 'toast-info'}`;
            toast.innerHTML = `<div class="toast-message">${escapeHtml(message)}</div>`;
            toastContainer.appendChild(toast);
            
            // Показываем тост и скрываем через некоторое время
            setTimeout(function() {
                toast.style.opacity = '1';
            }, 10);
            
            setTimeout(function() {
                toast.style.opacity = '0';
                setTimeout(function() {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        // Обновляем обработку ошибок в существующем коде
        function handleError(error) {
            console.error('Ошибка:', error);
            showToast(error.message || 'Произошла ошибка при выполнении операции');
        }

        // Функция для безопасного эскейпа HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Устанавливаем CSRF-токен для всех AJAX запросов
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Добавляем CSRF-токен к каждому AJAX запросу
        function setupAjaxCSRF() {
            const oldXHROpen = window.XMLHttpRequest.prototype.open;
            window.XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
                const xhr = this;
                oldXHROpen.apply(xhr, arguments);
                
                if (method.toLowerCase() === 'post') {
                    xhr.setRequestHeader('X-CSRF-Token', csrfToken);
                }
            };
        }
        setupAjaxCSRF();
        
        // Добавляем CSRF токен к Dropzone запросам
        if (typeof Dropzone !== 'undefined') {
            Dropzone.prototype.defaultOptions.headers = {
                'X-CSRF-Token': csrfToken
            };
        }
        
        // Функция удаления файла с CSRF защитой
        async function deleteFile(filename) {
            if (confirm(`Вы уверены, что хотите удалить файл "${escapeHtml(filename)}"?`)) {
                try {
                    const response = await fetch(`/space/${linkId}/delete/${encodeURIComponent(filename)}`, {
                        method: 'POST',
                        headers: {
                            'X-CSRF-Token': csrfToken
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        location.reload();
                    } else if (result.error) {
                        showToast(result.error, 'error');
                    }
                } catch (error) {
                    showToast('Произошла ошибка при удалении файла', 'error');
                    console.error('Ошибка:', error);
                }
            }
        }
        
        // Функция удаления всех файлов с CSRF защитой
        async function deleteAllFiles() {
            if (confirm('Вы уверены, что хотите удалить все файлы и хранилище?')) {
                try {
                    const response = await fetch(`/space/${linkId}/delete-all`, {
                        method: 'POST',
                        headers: {
                            'X-CSRF-Token': csrfToken
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.href = '/';
                    } else if (result.error) {
                        showToast(result.error, 'error');
                    }
                } catch (error) {
                    showToast('Произошла ошибка при удалении хранилища', 'error');
                    console.error('Ошибка:', error);
                }
            }
        }
        
        // Скачивание нескольких файлов
        async function downloadSelected() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const files = [];
            
            if (checkboxes.length === 0) {
                showToast('Выберите файлы для скачивания', 'error');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                files.push(checkbox.value);
            });
            
            try {
                const response = await fetch(`/space/${linkId}/download-multiple`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        files: files
                    })
                });
                
                if (response.ok) {
                    // Создаем элемент для принудительной загрузки файла
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `files_${linkId}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    const text = await response.text();
                    showToast(`Ошибка при скачивании файлов: ${escapeHtml(text)}`, 'error');
                }
            } catch (error) {
                showToast('Произошла ошибка при скачивании файлов', 'error');
                console.error('Ошибка:', error);
            }
        }
    </script>
</body>
</html> 